const playPauseButton=document.getElementById("playPauseButton"),currentTime=document.getElementById("currentTime"),totalTime=document.getElementById("totalTime"),playerAudio=document.getElementById("playerAudio"),lyric=document.getElementById("lyric"),lyricToggleButton=document.getElementById("lyricToggleButton"),EQToggleButton=document.getElementById("EQToggleButton"),Spectrum=document.getElementById("spectrum"),playModeButton=document.getElementById("playModeButton"),lastButton=document.getElementById("lastButton"),nextButton=document.getElementById("nextButton"),progress=document.getElementById("progress"),expandButton=document.getElementById("expandButton"),closeButton=document.getElementById("closeButton"),title=document.getElementById("title"),description=document.getElementById("description"),album=document.getElementById("album"),disk=document.getElementById("disk"),artist=document.getElementById("artist"),background=document.getElementById("background");let player={isPlaying:!1,playMode:0,playList:[],playingIndex:0,description:"",artist:"",album:"",title:"",isFullscreen:!1,openLyric:!0,lyric:[],lyricNumber:0,lyricInterval:null,openSpectrum:!0,themeColor:"",progressPercent:0,progressInterval:null,haveSpectrum:!1,volume:100,diskDegree:0,diskInterval:null,currentTime:null,totalTime:null,currentAudioSrc:null,timeInterval:null,init:function(){player.isPlaying=!1,player.isFullscreen=!1,player.openLyric=!0,player.openSpectrum=!0,player.playMode=1},next:function(){player.change("next")},last:function(){player.change("last")},change:function(e){if(player.pause(),player.lyricNumber=0,player.diskDegree=0,"next"===e)if(0===player.playMode)player.isPlaying=!0;else if(1===player.playMode){player.playingIndex+1>=player.playList.length?player.playingIndex=0:player.playingIndex++;let e=player.playList[player.playingIndex];player.load(e.title,e.description,e.artist,e.album,e.musicSrc,e.lyricSrc,e.coverImageSrc,e.themeColor,e.backgroundSrc),player.isPlaying=!0}},load:function(e,t,r,n,l,i,a,o,c){player.title=e,player.description=t,player.artist=r,player.album=n,playerAudio.src=l,player.getLyric(i),disk.style.backgroundImage='url("'+a+'")',player.themeColor=o,null==a?background.style.display="none":(background.style.display="block",background.style.backgroundImage='url("'+c+'")')},play:function(){player.haveSpectrum||(player.haveSpectrum=!0,beginSpectrum()),player.totalTime=parseSecondToTimeString(playerAudio.duration),totalTime.innerText=player.totalTime,document.getElementById("playerAudio").play(),this.diskInterval=setInterval(function(){disk.style.transform="rotate("+player.diskDegree+"deg)",player.diskDegree+=.1,player.diskDegree>=360&&(player.diskDegree=0)},1e3/60),player.timeInterval=setInterval(function(){player.currentTime=parseSecondToTimeString(playerAudio.currentTime),player.totalTime=parseSecondToTimeString(playerAudio.duration)},1e3/60),player.progressInterval=setInterval(function(){if(isNaN(playerAudio.duration));else{let e=playerAudio.currentTime/playerAudio.duration*100;progress.setAttribute("style","background-image:linear-gradient(90deg, #0075ff 0%,#0075ff "+(e-.1)+"%,black "+e+"%,black 100%);")}},1e3/60),null==player.lyric||0===player.lyric.length?lyric.innerText="纯音乐，请您欣赏":player.lyricInterval=setInterval(function(){player.lyric.length>player.lyricNumber+1&&playerAudio.currentTime>=player.lyric[player.lyricNumber+1].t&&(lyric.innerText=player.lyric[++player.lyricNumber].l)},100)},pause:function(){playerAudio.pause(),clearInterval(player.diskInterval),clearInterval(player.lyricInterval),lyric.innerText="",clearInterval(player.timeInterval),clearInterval(player.progressInterval)},getLyric:function(e){if(null==e)return void(player.lyric=null);let t=new XMLHttpRequest;t.open("GET",e,!1),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){let e=t.responseText;console.log(e);let r=/\[(\d{2}):(\d{2})\.(\d{2,3})](.*)/g,n=[];for(;;){let t=r.exec(e);if(!t)break;{let e=60*parseInt(t[1])+parseInt(t[2])+.001*parseInt(t[3]);n.push({t:e,l:t[4]})}}player.lyric=n,console.log(player.lyric)}},t.send(null)},fullscreen:function(){document.documentElement.requestFullscreen()},exitFullscreen:function(){document.exitFullscreen()},addList(e){player.playList=[];for(let t of e)player.playList.push(t);if(0!==player.playList.length){let e=player.playList[0];this.load(e.title,e.description,e.artist,e.album,e.musicSrc,e.lyricSrc,e.coverImageSrc,e.themeColor,e.backgroundSrc)}},changeProgress(e){playerAudio.currentTime=e;for(let e=0;e<player.lyric.length;e++)if(playerAudio.currentTime<player.lyric[e].t)return player.lyricNumber=e-1,void(lyric.innerText=player.lyric[player.lyricNumber].l)},handleEnding(){player.isPlaying=!1,player.lyricNumber=0,clearInterval(player.timeInterval),player.next()}};Object.defineProperty(player,"isPlaying",{get:function(){return this._isPlaying},set:function(e){!0===e?(this._isPlaying=!0,playPauseButton.innerHTML='<i class="fa fa-pause" aria-hidden="true">',player.play()):!1===e&&(this._isPlaying=!1,playPauseButton.innerHTML='<i class="fa fa-play" aria-hidden="true">',player.pause())}}),Object.defineProperty(player,"currentTime",{get:function(){return this._currentTime},set:function(e){this._currentTime=e,currentTime.innerHTML=e}}),Object.defineProperty(player,"totalTime",{get:function(){return this._totalTime},set:function(e){playerAudio.ended&&player.handleEnding(),this._totalTime=e,totalTime.innerHTML=e}}),Object.defineProperty(player,"title",{get:function(){return this._title},set:function(e){this._title=e,title.innerText=e}}),Object.defineProperty(player,"description",{get:function(){return this._description},set:function(e){this._description=e,description.innerText=e}}),Object.defineProperty(player,"artist",{get:function(){return this._artist},set:function(e){this._artist=e,artist.innerText=e}}),Object.defineProperty(player,"album",{get:function(){return this._album},set:function(e){this._album=e,album.innerText=e}}),Object.defineProperty(player,"currentAudioSrc",{get:function(){return this._currentAudioSrc},set:function(e){null!=e&&""!==e&&(this._currentAudioSrc=e,playerAudio.src=this.currentAudioSrc)}}),Object.defineProperty(player,"volume",{get:function(){return this._volume},set:function(e){e>=0&&e<=100&&(this._volume=e,playerAudio.volume=.01*e)}}),Object.defineProperty(player,"playMode",{get:function(){return this._playMode},set:function(e){if(e>=0&&e<=2){this._playMode=e;let t="";t=0===e?'<i class="fa fa-repeat" aria-hidden="true"></i>':1===e?'<i class="fa fa-indent" aria-hidden="true"></i>':'<i class="fa fa-random" aria-hidden="true"></i>',playModeButton.innerHTML=t}}}),Object.defineProperty(player,"openLyric",{get:function(){return this._openLyric},set:function(e){!0===e?(this._openLyric=!0,lyric.classList.add("active"),lyricToggleButton.classList.add("active")):!1===e&&(this._openLyric=!1,lyric.classList.remove("active"),lyricToggleButton.classList.remove("active"))}}),Object.defineProperty(player,"openSpectrum",{get:function(){return this._openSpectrum},set:function(e){!0===e?(this._openSpectrum=!0,EQToggleButton.classList.add("active"),Spectrum.classList.add("active")):!1===e&&(this._openSpectrum=!1,EQToggleButton.classList.remove("active"),Spectrum.classList.remove("active"))}}),Object.defineProperty(player,"isFullscreen",{get:function(){return this._isFullscreen},set:function(e){!0===e?(this._isFullscreen=!0,expandButton.innerHTML='<i class="fa fa-compress" aria-hidden="true"></i>',player.fullscreen()):!1===e&&!0===player.isFullscreen&&(this._isFullscreen=!1,expandButton.innerHTML='<i class="fa fa-expand" aria-hidden="true"></i>',player.exitFullscreen())}}),Object.defineProperty(player,"themeColor",{get:function(){return this._themeColor},set:function(e){this._themeColor=e,lyric.style.textShadow=player.themeColor+" 1px 1px 4px"}}),playPauseButton.onclick=function(){player.isPlaying=!player.isPlaying},lyricToggleButton.onclick=function(){player.openLyric=!player.openLyric},EQToggleButton.onclick=function(){player.openSpectrum=!player.openSpectrum},expandButton.onclick=function(){player.isFullscreen=!player.isFullscreen},closeButton.onclick=function(){window.opener=null,window.open("","_self"),window.close()},progress.onclick=function(e){player.changeProgress(e.screenX/window.innerWidth*playerAudio.duration)},playModeButton.onclick=function(){2===player.playMode?player.playMode=0:player.playMode+=1},nextButton.onclick=function(){player.next()},lastButton.onclick=function(){player.last()},window.onload=function(){player.init()},player.addList(demoPlayList);